<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UD Impact 자산 대여 관리자</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium; }
    .badge-green { @apply bg-green-100 text-green-800; }
    .badge-yellow { @apply bg-yellow-100 text-yellow-800; }
    .badge-red { @apply bg-red-100 text-red-800; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-3 py-2 text-sm font-semibold shadow-sm border border-gray-200 hover:bg-gray-50 disabled:opacity-50; }
    .btn-primary { @apply bg-black text-white border-black hover:bg-gray-800; }
    .input { @apply block w-full rounded-lg border-gray-300 focus:border-black focus:ring-black; }
    .label { @apply block text-sm font-semibold text-gray-900 mb-1; }
    .card { @apply bg-white rounded-2xl shadow-sm border border-gray-300 p-4 space-y-4; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.75); backdrop-filter: blur(4px); z-index:40; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-lg font-semibold">UD Impact 자산 대여 관리자</h1>
      <div class="flex items-center gap-2">
        <div id="signedOut">
          <button id="signInBtn" class="btn btn-primary">Google 로그인</button>
        </div>
        <div id="signedIn" class="hidden items-center gap-2">
          <span id="userEmail" class="text-sm text-gray-900 font-medium"></span>
          <button id="signOutBtn" class="btn">로그아웃</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6 space-y-6">
    <div id="guard" class="hidden card border-red-400">
      <p class="text-red-600 font-semibold">관리자만 접근할 수 있습니다. 관리자 계정으로 로그인해주세요.</p>
    </div>

    <!-- 대기중 신청 -->
    <section id="pendingSection" class="card hidden">
      <div class="px-4 py-3 border-b bg-gray-50 flex items-center justify-between">
        <h2 class="font-semibold">대여 신청 승인 대기</h2>
      </div>
      <div class="p-4">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">자산명</th>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">그룹/대여자</th>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">기간</th>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">코멘트</th>
                <th class="px-2 py-1"></th>
              </tr>
            </thead>
            <tbody id="pendingTbody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 자산 목록 -->
    <section id="assetSection" class="card hidden">
      <div class="px-4 py-3 border-b bg-gray-50 flex items-center justify-between">
        <h2 class="font-semibold">자산 목록</h2>
      </div>
      <div class="p-4">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">자산명</th>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">설명</th>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">사진</th>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">상태</th>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">비고</th>
                <th class="px-2 py-1 text-sm font-semibold text-gray-900">관리</th>
              </tr>
            </thead>
            <tbody id="assetTbody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- 자산 등록 -->
    <section id="createSection" class="card hidden">
      <div class="px-4 py-3 border-b bg-gray-50 flex items-center justify-between">
        <h2 class="font-semibold">자산 등록</h2>
        <button id="assetCreateBtn" class="btn btn-primary">등록</button>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-2 gap-3">
          <div class="col-span-2"><label class="label">자산명 *</label><input id="c_name" class="input" /></div>
          <div class="col-span-2"><label class="label">자산설명 *</label><textarea id="c_desc" class="input"></textarea></div>
          <div><label class="label">종류</label><input id="c_type" class="input" /></div>
          <div><label class="label">카테고리</label><input id="c_category" class="input" /></div>
          <div><label class="label">시리얼</label><input id="c_serial" class="input" /></div>
          <div><label class="label">보관 위치</label><input id="c_loc" class="input" /></div>
          <div class="col-span-2"><label class="label">사진 *</label><input id="c_photo" type="file" accept="image/*" class="input" /></div>
        </div>
      </div>
    </section>
  </main>

  <div id="backdrop" class="modal-backdrop hidden"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDocs, addDoc, updateDoc, deleteDoc, orderBy, query, where } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyANws_YQC_kEHrn_o2I1vx-OULeijIHw0w",
      authDomain: "udrent-927a2.firebaseapp.com",
      projectId: "udrent-927a2",
      storageBucket: "udrent-927a2.firebasestorage.app",
      messagingSenderId: "84954058245",
      appId: "1:84954058245:web:3b4a52ccfc52a59fce166c",
      measurementId: "G-E34CKZ1F4M"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const ADMIN_WHITELIST = ["hoony@udimpact.ai","hangsun@udimpact.ai"];
    const STATUS = { AVAILABLE:'대여가능', RENTED:'대여중', PENDING:'대여심사중' };

    const provider=new GoogleAuthProvider();
    async function signInGoogle(){
      const {user}=await signInWithPopup(auth,provider);
      if(!user.email.endsWith('@udimpact.ai')){await signOut(auth);alert('사내 계정(@udimpact.ai)만 접근 가능합니다.');}
    }
    async function doSignOut(){await signOut(auth);}

    onAuthStateChanged(auth,async(user)=>{
      if(!user){
        document.getElementById('signedIn').classList.add('hidden');
        document.getElementById('signedOut').classList.remove('hidden');
        hideAdminSections();
        return;
      }
      document.getElementById('signedIn').classList.remove('hidden');
      document.getElementById('signedOut').classList.add('hidden');
      document.getElementById('userEmail').textContent=user.email;

      if(!ADMIN_WHITELIST.includes(user.email)){
        hideAdminSections();
        document.getElementById('guard').classList.remove('hidden');
      } else {
        document.getElementById('guard').classList.add('hidden');
        showAdminSections();
        await loadAssets();
        renderAssets();
        await renderPendingRequests();
      }
    });

    function hideAdminSections(){
      document.getElementById('pendingSection').classList.add('hidden');
      document.getElementById('assetSection').classList.add('hidden');
      document.getElementById('createSection').classList.add('hidden');
    }
    function showAdminSections(){
      document.getElementById('pendingSection').classList.remove('hidden');
      document.getElementById('assetSection').classList.remove('hidden');
      document.getElementById('createSection').classList.remove('hidden');
    }

    const colAssets=collection(db,'assets');
    const colRequests=collection(db,'rentalRequests');

    async function loadAssets(){
      const snap=await getDocs(query(colAssets,orderBy('name')));
      window.assets=snap.docs.map(d=>({id:d.id,...d.data()}));
    }

    function setBadge(el,status){
      el.className='badge ' + (status===STATUS.AVAILABLE? 'badge-green': status===STATUS.RENTED? 'badge-red':'badge-yellow');
      el.textContent=status;
    }

    // Helpers for pending approvals
    function fmtDateLocal(s){ try { return s ? new Date(s).toLocaleDateString('ko-KR') : '-'; } catch(e){ return s||'-'; } }
    async function setAssetStatus(assetId, status, holder=null){
      await updateDoc(doc(db,'assets',assetId), { currentStatus: status, currentHolder: status===STATUS.RENTED ? holder : null });
    }
    async function normalizeAssetStatus(assetId){
      const pendSnap = await getDocs(query(colRequests, where('assetId','==',assetId), where('status','==','pending')));
      if(pendSnap.size>0){ await setAssetStatus(assetId, STATUS.PENDING, null); return; }
      const approvedSnap = await getDocs(query(colRequests, where('assetId','==',assetId), where('status','==','approved')));
      if(approvedSnap.size>0){
        const d = approvedSnap.docs[0].data();
        await setAssetStatus(assetId, STATUS.RENTED, { groupName:d.groupName, renterName:d.renterName, endDate:d.endDate });
      } else {
        await setAssetStatus(assetId, STATUS.AVAILABLE, null);
      }
    }
    async function approveRequest(r){
      await updateDoc(doc(db,'rentalRequests', r.id), { status:'approved' });
      await setAssetStatus(r.assetId, STATUS.RENTED, { groupName:r.groupName, renterName:r.renterName, endDate:r.endDate });
    }
    async function declineRequest(r, comment=''){
      await updateDoc(doc(db,'rentalRequests', r.id), { status:'declined', adminComment: comment });
      await normalizeAssetStatus(r.assetId);
    }
    async function renderPendingRequests(){
      const snap = await getDocs(query(colRequests, where('status','==','pending'), orderBy('createdAt')));
      const tbody = document.getElementById('pendingTbody'); if(!tbody) return;
      tbody.innerHTML='';
      snap.docs.forEach(d=>{
        const r = { id:d.id, ...d.data() };
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-2 py-1 text-gray-900">${r.assetName || r.assetId}</td>
          <td class="px-2 py-1 text-gray-800">${r.groupName} / ${r.renterName}</td>
          <td class="px-2 py-1 text-gray-700">${fmtDateLocal(r.startDate)} ~ ${fmtDateLocal(r.endDate)}</td>
          <td class="px-2 py-1"><input class="input" placeholder="코멘트(선택)" data-field="comment" /></td>
          <td class="px-2 py-1 flex gap-2 justify-end">
            <button class="btn btn-primary" data-action="approve">승인</button>
            <button class="btn" data-action="decline">거절</button>
          </td>`;
        tr.querySelector('[data-action="approve"]').addEventListener('click', async ()=>{
          await approveRequest(r);
          await renderPendingRequests();
          await loadAssets();
          renderAssets();
        });
        tr.querySelector('[data-action="decline"]').addEventListener('click', async ()=>{
          const c = tr.querySelector('[data-field="comment"]').value.trim();
          await declineRequest(r, c);
          await renderPendingRequests();
          await loadAssets();
          renderAssets();
        });
        tbody.appendChild(tr);
      });
      const countEl = document.getElementById('pendingCount'); if(countEl) countEl.textContent = snap.size;
    }

    function renderAssets(){
      const tbody=document.getElementById('assetTbody');tbody.innerHTML='';
      window.assets.forEach(a=>{
        const tr=document.createElement('tr');
        const photoCell = a.photoUrl ? `<img src="${a.photoUrl}" alt="asset" class="w-16 h-16 object-cover rounded"/>` : '-';
        tr.innerHTML=`<td class='px-2 py-1 font-semibold text-gray-900'>${a.name}</td><td class='px-2 py-1 text-gray-700'>${a.description||''}</td><td class='px-2 py-1'>${photoCell}</td><td class='px-2 py-1'><span class='badge'></span></td><td class='px-2 py-1 text-gray-700'>${a.currentStatus===STATUS.RENTED && a.currentHolder? a.currentHolder.groupName+'/'+a.currentHolder.renterName:'-'}</td><td class='px-2 py-1 flex gap-1'><button class='btn' onclick='returnAsset("${a.id}")'>반납</button><button class='btn' onclick='deleteAsset("${a.id}")'>삭제</button></td>`;
        setBadge(tr.querySelector('.badge'),a.currentStatus||STATUS.AVAILABLE);
        tbody.appendChild(tr);
      });
    }

    window.returnAsset = async function(id){await updateDoc(doc(db,'assets',id),{currentStatus:STATUS.AVAILABLE,currentHolder:null});await loadAssets();renderAssets();}
    window.deleteAsset = async function(id){if(confirm('삭제하시겠습니까?')){await deleteDoc(doc(db,'assets',id));await loadAssets();renderAssets();}}

    document.getElementById('signInBtn').addEventListener('click',signInGoogle);
    document.getElementById('signOutBtn').addEventListener('click',doSignOut);

    document.getElementById('assetCreateBtn').addEventListener('click',async()=>{
      const name=document.getElementById('c_name').value.trim();
      const desc=document.getElementById('c_desc').value.trim();
      if(!name||!desc){alert('자산명과 설명은 필수입니다');return;}
      const type=document.getElementById('c_type').value.trim();
      const category=document.getElementById('c_category').value.trim();
      const serial=document.getElementById('c_serial').value.trim();
      const loc=document.getElementById('c_loc').value.trim();
      const file=document.getElementById('c_photo').files[0];

      const ref=await addDoc(colAssets,{name,description:desc,type,category,serialNumber:serial,location:loc,currentStatus:STATUS.AVAILABLE,createdAt:new Date()});
      if(file){
        const r=sRef(storage,`assets/${ref.id}/photo_${Date.now()}`);
        await uploadBytes(r,file);
        const url=await getDownloadURL(r);
        await updateDoc(doc(db,'assets',ref.id),{photoUrl:url});
      }
      await loadAssets();renderAssets();
    });
  </script>
</body>
</html>
