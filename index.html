<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UD Impact 자산 대여 대시보드</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .badge { @apply inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium; }
    .badge-green { @apply bg-green-100 text-green-800; }
    .badge-yellow { @apply bg-yellow-100 text-yellow-800; }
    .badge-red { @apply bg-red-100 text-red-800; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-3 py-2 text-sm font-semibold shadow-sm border border-gray-200 hover:bg-gray-50 disabled:opacity-50; }
    .btn-primary { @apply bg-black text-white border-black hover:bg-gray-800; }
    .input { @apply block w-full rounded-lg border-gray-300 focus:border-black focus:ring-black; }
    .label { @apply block text-sm font-medium text-gray-700 mb-1; }
    .card { @apply bg-white rounded-2xl shadow-sm border border-gray-200; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getFirestore, collection, doc, getDocs, query, where, orderBy, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyANws_YQC_kEHrn_o2I1vx-OULeijIHw0w",
      authDomain: "udrent-927a2.firebaseapp.com",
      projectId: "udrent-927a2",
      storageBucket: "udrent-927a2.firebasestorage.app",
      messagingSenderId: "84954058245",
      appId: "1:84954058245:web:3b4a52ccfc52a59fce166c",
      measurementId: "G-E34CKZ1F4M"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const STATE = { user: null, assets: [], filters: { status: "", q: "", type: "" }, selectedAsset: null };

    const STATUS = { AVAILABLE: '대여가능', RENTED: '대여중', PENDING: '대여심사중' };

    const $ = (sel) => document.querySelector(sel);
    const fmtDate = (s) => new Date(s).toLocaleDateString('ko-KR');

    function setBadge(el, status) {
      el.className = 'badge ' + (status===STATUS.AVAILABLE? 'badge-green': status===STATUS.RENTED? 'badge-red' : 'badge-yellow');
      el.textContent = status;
    }

    const provider = new GoogleAuthProvider();
    async function signInGoogle() {
      const { user } = await signInWithPopup(auth, provider);
      if (!user.email.endsWith('@udimpact.ai')) {
        await signOut(auth);
        alert('사내 계정(@udimpact.ai)만 접근 가능합니다.');
      }
    }
    async function doSignOut() { await signOut(auth); }

    const colAssets = collection(db, 'assets');
    const colRequests = collection(db, 'rentalRequests');

    async function loadAssets() {
      const snap = await getDocs(query(colAssets, orderBy('name')));
      STATE.assets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    async function submitRentalRequest(asset, { groupName, renterName, startDate, endDate }) {
      const qs = query(colRequests, where('assetId', '==', asset.id), where('status', '==', 'approved'));
      const snap = await getDocs(qs);
      const s = new Date(startDate).getTime();
      const e = new Date(endDate).getTime();
      const overlaps = snap.docs.some(d => {
        const r = d.data();
        const s2 = new Date(r.startDate).getTime();
        const e2 = new Date(r.endDate).getTime();
        return !(e < s2 || e2 < s);
      });
      if (overlaps) throw new Error('해당 기간에는 이미 대여가 있어 신청할 수 없습니다.');

      await addDoc(colRequests, { assetId: asset.id, assetName: asset.name, groupName, renterName, startDate, endDate, status: 'pending', createdBy: STATE.user.email, createdAt: serverTimestamp() });
      await updateDoc(doc(db, 'assets', asset.id), { currentStatus: STATUS.PENDING });
    }

    function renderAssets() {
      const tbody = $('#assetTbody');
      tbody.innerHTML = '';
      STATE.assets.filter(a => true).forEach(a => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50 cursor-pointer';
        tr.innerHTML = `
          <td class="px-3 py-2 font-medium text-gray-900">${a.name||''}</td>
          <td class="px-3 py-2 text-gray-600">${a.description||''}</td>
          <td class="px-3 py-2"><span class="badge"></span></td>
          <td class="px-3 py-2 text-gray-600">${a.currentStatus===STATUS.RENTED && a.currentHolder? `${a.currentHolder.groupName} / ${a.currentHolder.renterName}`: '-'}</td>
        `;
        tr.addEventListener('click', ()=> openAssetDetail(a));
        tbody.appendChild(tr);
        setBadge(tr.querySelector('.badge'), a.currentStatus || STATUS.AVAILABLE);
      });
    }

    function openAssetDetail(asset) {
      STATE.selectedAsset = asset;
      $('#d_name').textContent = asset.name||'';
      $('#d_desc').textContent = asset.description||'';
      const st = $('#d_status'); setBadge(st, asset.currentStatus||STATUS.AVAILABLE);
      $('#d_remark').textContent = (asset.currentStatus===STATUS.RENTED && asset.currentHolder) ? `${asset.currentHolder.groupName} / ${asset.currentHolder.renterName} (~ ${fmtDate(asset.currentHolder.endDate)})` : '-';
      $('#applyBtn').disabled = asset.currentStatus !== STATUS.AVAILABLE;
      $('#assetDetailModal').classList.remove('hidden');
    }

    function closeDetail() { $('#assetDetailModal').classList.add('hidden'); }

    async function onSubmitApply() {
      const a = STATE.selectedAsset; if (!a) return;
      const groupName = $('#apply_group').value.trim();
      const renterName = $('#apply_renter').value.trim();
      const startDate = $('#apply_start').value;
      const endDate = $('#apply_end').value;
      if (!groupName || !renterName || !startDate || !endDate) { alert('모두 입력해주세요'); return; }
      if (new Date(endDate) < new Date(startDate)) { alert('종료일이 시작일보다 빠릅니다'); return; }
      try {
        await submitRentalRequest(a, { groupName, renterName, startDate, endDate });
        alert('대여 신청이 접수되었습니다.');
        $('#applyModal').classList.add('hidden');
        await loadAssets();
        renderAssets();
        closeDetail();
      } catch (e) { alert(e.message); }
    }

    onAuthStateChanged(auth, async (user) => {
      STATE.user = user;
      if (user && user.email?.endsWith('@udimpact.ai')) {
        $('#signedIn').classList.remove('hidden');
        $('#signedOut').classList.add('hidden');
        $('#userEmail').textContent = user.email;
        await loadAssets();
        renderAssets();
      } else {
        $('#signedIn').classList.add('hidden');
        $('#signedOut').classList.remove('hidden');
        $('#userEmail').textContent = '';
        $('#assetTbody').innerHTML = '';
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      $('#signInBtn').addEventListener('click', signInGoogle);
      $('#signOutBtn').addEventListener('click', doSignOut);
      $('#detailClose').addEventListener('click', closeDetail);
      $('#applyBtn').addEventListener('click', ()=>{
        const a = STATE.selectedAsset; if (!a) return;
        $('#apply_assetName').textContent = a.name;
        $('#apply_group').value = '';
        $('#apply_renter').value = STATE.user?.displayName || '';
        $('#apply_start').value = '';
        $('#apply_end').value = '';
        $('#applyModal').classList.remove('hidden');
      });
      $('#applyCancel').addEventListener('click', ()=> $('#applyModal').classList.add('hidden'));
      $('#applySubmit').addEventListener('click', onSubmitApply);
    });
  </script>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white border-b border-gray-200 sticky top-0 z-40">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-lg font-semibold">UD Impact 자산 대여 대시보드</h1>
      <div class="flex items-center gap-2">
        <div id="signedOut" class="ml-2">
          <button id="signInBtn" class="btn btn-primary">Google 로그인</button>
        </div>
        <div id="signedIn" class="hidden items-center gap-2 ml-2">
          <span id="userEmail" class="text-sm text-gray-600"></span>
          <button id="signOutBtn" class="btn">로그아웃</button>
        </div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <section class="space-y-4">
      <div class="card overflow-hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500">자산명</th>
                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500">설명</th>
                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500">상태</th>
                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500">비고</th>
              </tr>
            </thead>
            <tbody id="assetTbody" class="divide-y divide-gray-100 bg-white"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <section id="assetDetailModal" class="hidden fixed inset-0 bg-black/30 z-40 flex items-center justify-center p-4">
    <div class="card max-w-md w-full">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <h3 class="font-semibold">자산 상세</h3>
        <button id="detailClose" class="btn">닫기</button>
      </div>
      <div class="p-4 space-y-2 text-sm">
        <div><span class="text-gray-500">자산명</span> : <span id="d_name"></span></div>
        <div><span class="text-gray-500">설명</span> : <span id="d_desc"></span></div>
        <div><span class="text-gray-500">상태</span> : <span id="d_status" class="badge"></span></div>
        <div><span class="text-gray-500">비고</span> : <span id="d_remark"></span></div>
      </div>
      <div class="px-4 pb-4">
        <button id="applyBtn" class="btn btn-primary w-full">대여 신청</button>
      </div>
    </div>
  </section>

  <section id="applyModal" class="hidden fixed inset-0 bg-black/30 z-50 flex items-center justify-center p-4">
    <div class="card max-w-md w-full">
      <div class="flex items-center justify-between px-4 py-3 border-b">
        <h3 class="font-semibold">대여 신청: <span id="apply_assetName"></span></h3>
        <button id="applyCancel" class="btn">닫기</button>
      </div>
      <div class="p-4 space-y-3">
        <div>
          <label class="label">그룹명 *</label>
          <input id="apply_group" class="input" />
        </div>
        <div>
          <label class="label">대여자명 *</label>
          <input id="apply_renter" class="input" />
        </div>
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="label">시작일 *</label>
            <input id="apply_start" type="date" class="input" />
          </div>
          <div>
            <label class="label">종료일 *</label>
            <input id="apply_end" type="date" class="input" />
          </div>
        </div>
      </div>
      <div class="px-4 pb-4">
        <button id="applySubmit" class="btn btn-primary w-full">신청 제출</button>
      </div>
    </div>
  </section>

  <footer class="text-center py-8 text-xs text-gray-400">© UD Impact</footer>
</body>
</html>
